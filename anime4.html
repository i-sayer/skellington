<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Going for the old tv between channels look">
    <title>Midi Animation</title>
    <style>
        body, html {
            padding: 0;
            margin:  0;
            background-color: black;
            /* background: linear-gradient(30deg, black 45%, lightgreen 46%, black 47%); */
        }
        video {
            position: absolute;
            left:0; right:0; top:0; bottom:0;
            width: 100vw;
            height: 100vh;
            opacity: 0.5;
            /* filter:invert(); */
            filter:hue-rotate(90deg) invert();
        }
        #twelve {
            display: grid;
            box-sizing: border-box;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 0;
        }
        #twelve>div {
            /* outline: 1px solid black; */
            height:33.33vh;
            position: relative;
            /* filter: blur(0.5px); */
        }
        #twelve>div>svg {
            position: absolute;
            left:0;
            top:0;
        }
        #twelve>div>canvas {
            position: absolute;
            left:0;
            top:0;
            transform: translate(50%,50%) scale(1.99);
            filter: grayscale(1) brightness(7);
        }
        #twelve>div {
            background: repeating-linear-gradient(transparent, transparent 50%,rgba(255,255,255,0.3) 99%);
            background-size: 100% 90%;
            animation: roll1 cubic-bezier(0.68, -0.6, 0.32, 1.6) infinite alternate forwards;
        }
        @keyframes roll1 {
            from {
                background-position-y: 0;
            }
            to {
                background-position-y: 33vh;

            }
        }
    </style>
</head>
<body>
    <svg style="display:none">
        <symbol id="mask">
            <path d="M 0,0 V 96.559311 H 144.23753 V 0 Z m 6.7540187,3.7197245 c 43.5764983,-1.059478 87.1529963,-0.8700264 130.7295013,0 1.06245,0.021213 1.87297,0.8560651 1.91827,1.9177565 1.22792,28.77895 1.47415,57.27742 0,85.284349 -0.0559,1.06119 -0.85651,1.874765 -1.91827,1.918272 -43.35444,1.776504 -86.990342,1.301292 -130.7295013,0 -1.0621875,-0.0316 -1.8700721,-0.856707 -1.9182738,-1.918272 -1.2908148,-28.428115 -1.4147938,-56.856234 0,-85.284349 0.052821,-1.0613439 0.8556164,-1.9177567 1.9182738,-1.9177565 z">
            </path>
        </symbol>
    </svg>
    <section id="twelve">
        <div>
            <svg viewBox="0 0 144.19531 96.53125" preserveAspectRatio="none" width="100%" height="100%"><use xlink:href="#mask"></use></svg>
        </div>
        <div>
            <svg viewBox="0 0 144.19531 96.53125" preserveAspectRatio="none" width="100%" height="100%"><use xlink:href="#mask"></use></svg>
        </div>
        <div>
            <svg viewBox="0 0 144.19531 96.53125" preserveAspectRatio="none" width="100%" height="100%"><use xlink:href="#mask"></use></svg>
        </div>
        <div>
            <svg viewBox="0 0 144.19531 96.53125" preserveAspectRatio="none" width="100%" height="100%"><use xlink:href="#mask"></use></svg>
        </div>
        <div>
            <svg viewBox="0 0 144.19531 96.53125" preserveAspectRatio="none" width="100%" height="100%"><use xlink:href="#mask"></use></svg>
        </div>
        <div>
            <svg viewBox="0 0 144.19531 96.53125" preserveAspectRatio="none" width="100%" height="100%"><use xlink:href="#mask"></use></svg>
        </div>
        <div>
            <svg viewBox="0 0 144.19531 96.53125" preserveAspectRatio="none" width="100%" height="100%"><use xlink:href="#mask"></use></svg>
        </div>
        <div>
            <svg viewBox="0 0 144.19531 96.53125" preserveAspectRatio="none" width="100%" height="100%"><use xlink:href="#mask"></use></svg>
        </div>
        <div>
            <svg viewBox="0 0 144.19531 96.53125" preserveAspectRatio="none" width="100%" height="100%"><use xlink:href="#mask"></use></svg>
        </div>
        <div>
            <svg viewBox="0 0 144.19531 96.53125" preserveAspectRatio="none" width="100%" height="100%"><use xlink:href="#mask"></use></svg>
        </div>
        <div>
            <svg viewBox="0 0 144.19531 96.53125" preserveAspectRatio="none" width="100%" height="100%"><use xlink:href="#mask"></use></svg>
        </div>
        <div>
            <svg viewBox="0 0 144.19531 96.53125" preserveAspectRatio="none" width="100%" height="100%"><use xlink:href="#mask"></use></svg>
        </div>
    </section>
    <script>
        // put a canvas element in each div
        let cnt = twelve.children.length;
        let div = twelve.children[0];
        let rec = div.getClientRects()[0];
        let hw = rec.width>>1;
        let hh = rec.height>>1;
        var ctx, slaves = [];
        for (let i=0; i<cnt; i++){
            div = twelve.children[i];
            let rollspeed = (2000 + (Math.random()*1500))+"ms";
            let can = document.createElement("canvas");
            can.setAttribute("width",hw);
            can.setAttribute("height",hh);
            let _svg = div.removeChild(div.firstElementChild);
            div.style.animationDuration = rollspeed;
            // can.style.filter = `contrast(${40+Math.floor(Math.random()*60)}%)`;
            div.appendChild(can);
            div.appendChild(_svg);
            let _ctx = can.getContext("2d");
            if (i>0)
                slaves.push(_ctx);
            else
                ctx = _ctx; // our master
        }
        ctx.rect(0,0,hw,hh);
        ctx.fill();
        let pixdata = ctx.getImageData(0,0,hw,hh);
        let data = pixdata.data;
        let frame = 0;
        let tvNoise = function(){
            frame++;
            if (frame % 2)
                return window.requestAnimationFrame(tvNoise);
            for (let j=0; j<(hh/2); j++){
                let v = j * 2 * hw * 4;
                for (let i=0; i<hw; i++){
                    let rnd = Math.floor(Math.random()*255);
                    data[v+(i*4)] = rnd;
                    // data[v+(i*4+1)] = rnd;
                    // data[v+(i*4+2)] = rnd;
                    data[v+(i*4+3)] = rnd;
                }
            }
            ctx.putImageData(pixdata, 0, 0);
            slaves.forEach(u=>u.putImageData(pixdata, 0, 0));
            window.requestAnimationFrame(tvNoise);
        }
        window.requestAnimationFrame(tvNoise);
        const constraints = {video: true};
        var midi = null, mididev=0, clkcount=0;
        // navigator.mediaDevices.getUserMedia(constraints).then(stream => {video1.srcObject = stream});
        // function onMIDISuccess(midiAccess) {
        //     let txt = "";
        //     midi = midiAccess;  // store in the global (in real usage, would probably keep in an object instance)
        //     midiAccess.inputs.forEach(function (entry) { entry.onmidimessage = onMIDIMessage; });
        //     initSynth();
        // }

        // function onMIDIMessage(event){
        //     let cmd = event.data[0] >> 4;
        //     switch (cmd){
        //         case 0xf:
        //             break;
        //         case 9:
        //             // console.log(`${event.data[0].toString(16)} ${event.data[1]} ${event.data[2]}`);
        //             if (event.data[1]==60){
        //                 document.body.classList.add("pulse");
        //                 document.body.onanimationend = e => document.body.classList.remove("pulse");
        //             }
        //     }
        // }
        // navigator.requestMIDIAccess({ sysex: true }).then(onMIDISuccess, u=>consolelog("midi failed"));
    </script>
</body>
</html>
