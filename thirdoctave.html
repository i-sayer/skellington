<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1/3 Octave Spectrum Display</title>
    <style>
        :root {
            --barwidth: 10;
            --barcount: 32;
            --barspace: 4;
            --bartot: (var(--barwidth)+var(--barspace));
        }
        html, body {
            height: 100vh;
            display: grid;
            background-color: #202028;
        }
        #spectrumDisplay {
            display: inline-block;
            box-sizing: border-box;
            border: calc(var(--barspace)*0.25px) solid black;
            width: calc( var(--barcount) * (var(--barwidth) + var(--barspace)) * 1px);
            height: calc( var(--barcount) * (var(--barwidth) + var(--barspace)) * 0.5px);
            margin: auto;
            filter: blur(calc(var(--barspace)*0.2px));
            box-shadow: 0 2px 4px -2px black;
            background:
                linear-gradient(
                    90deg,
                    black calc(var(--barspace)*1px),
                    transparent calc(var(--barspace)*1px)
                ),
                linear-gradient(
                    black calc(var(--barspace)*1px),
                    transparent calc(var(--barspace)*1px)
                ),
                linear-gradient(
                    red calc((var(--barwidth) + var(--barspace)) * 1.5px),
                    orange 0,
                    orange calc((var(--barwidth) + var(--barspace)) * 3.5px),
                    lightgreen 0
                );
            background-repeat: repeat-x, repeat-y, none;
            background-size: calc((var(--barwidth) + var(--barspace)) * 1px) 100%,
             100% calc((var(--barwidth) + var(--barspace)) * 0.5px),
              auto;
            background-position-x: calc(var(--barspace) * -0.5px), 0, 0;
            background-position-y: 0, calc(var(--barspace) * -0.5px), 0;
        }
    </style>
</head>
<body>
    <canvas id="spectrumDisplay"></canvas>
    <audio src="3080.mp3" id="player" controls></audio>
    <script type="module">
        const sdc = document.getElementById("spectrumDisplay");
        const ctx=sdc.getContext("2d");
        const bound = sdc.getBoundingClientRect();
        sdc.width = bound.width;
        sdc.height = bound.height;

        ctx.fillStyle = "black";
        ctx.strokeWidth = 0;
        ctx.globalAlpha = 0.95;
        let i, j,
            barcnt = getComputedStyle(sdc).getPropertyValue("--barcount")>>0,
            barwid = spectrumDisplay.offsetWidth/barcnt;
        for (i=0; i<barcnt; i++)
            ctx.fillRect(i*barwid,0,barwid,i*(barwid/2));
        // get audio context and fill settings for each bar
        var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        var analyser = audioCtx.createAnalyser();
        var audio = document.getElementById("player");
        var bufferLength = analyser.frequencyBinCount;
        var dataArray = new Uint8Array(bufferLength);
        var wArray = new Uint8Array(bufferLength);
        let fftsize = 2048, samplerate, startfreqhz = 16;
        const cuberootof2 = Math.pow(2,(1/3));
        analyser.fftSize = fftsize;
        samplerate = audioCtx.sampleRate;

        // the frequency of each band, bk==1st bucket for band, wd==number of buckets to average
        var bands = [];
        var bandindex = 0, bandgap = samplerate/fftsize;
        for (i=0; i<barcnt; i++){
            bands.push({fr:Math.ceil(startfreqhz),bk:0,wd:1});
            startfreqhz *= cuberootof2;
        }
        j = 0;
        for (i=0; i<barcnt; i++){
            for (;j<bufferLength; j++){
                if (i>0)
                    bands[i-1].wd++;
                if ((j*bandgap)>bands[i].fr)
                    break;
            }
            bands[i].bk = j;
        }

        function draw() {
            requestAnimationFrame(draw);
            var h, w=4, o;
            analyser.getByteFrequencyData(dataArray);
            ctx.clearRect(0,0,barcnt*barwid,barcnt*barwid*0.5);
            bands.forEach((x, i) => {
                // sum all the buckets for this band then / num for average
                var i2, avr;
                for (avr=0, i2=x.bk; i2<(x.bk+x.wd); i2++)
                    avr += dataArray[i2];
                avr = (avr / x.wd)>>3;
                ctx.fillRect(i*barwid,0,barwid,(32-avr)*(barwid/2));
            });
        }
        audio.addEventListener('canplay', canplaynow, false);

        function canplaynow () {
            var source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            draw();
        }

    </script>
</body>
</html>