<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Read MMI Scan</title>
    <script src="quagga.min.js"></script>
    <script src="script/tiff.min.js"></script>
    <style>
        h3+canvas {
            /* border: 1px solid orange; */
            display: none;
        }
        #output>canvas{
            max-width: 50%;
        }
        label>input[type=file] {
            display: none;
        }
        label {
            padding: 2em;
            border: 1px solid silver;
            grid-column: 1 / -1;
        }
        body {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: repeat(12, calc(100vh/12));
        }
        div {
            grid-column: span 4;
        }
        div#output {
            grid-column: span 8;
            grid-row: span 12;            
        }
    </style>
</head>
<body>
    <label for="inputFile">Drop your tiff files here
        <input type="file" id="inputFile"/>
    </label>
<!-- <img id="preview" width="210" height="297"/> -->
<div id="output"></div>
<div><h3></h3><canvas id="Canvas1"></canvas></div>
<div><h3></h3><canvas id="Canvas3"></canvas></div>
<div><h3></h3><canvas id="Canvas2"></canvas></div>
<script>
    inputFile.oninput = function(e) {
        var reader = new FileReader();
        reader.onloadend = function(u)
        {
            //preview.src = reader.result;
            var tiff = new Tiff({buffer: reader.result});
            var tcanvas = tiff.toCanvas();
            if (tcanvas) {
                output.appendChild(tcanvas);
                let w = tiff.width();
                let h = tiff.height();
                [
                    {c:Canvas1, x:0, y:h*0.15, w:w*0.5, h:h*0.125},
                    {c:Canvas2, x:w*0.45, y:h*0.15, w:w*0.55, h:h*0.125},
                    {c:Canvas3, x:0, y:h-(h*0.2), w:w*0.75, h:h*0.2}
                ].forEach(function (c) {
                    let ctx = c.c.getContext('2d');
                    c.c.height = h/8;                
                    c.c.width = w/8;                
                    //ctx.filter = "blur(1.5px)";
                    ctx.drawImage(
                        tcanvas, c.x, c.y, c.w, c.h, 0, 0, w/8, h/8
                    );
                // get results
                getResults();
                });
            }
        };
        // reader.readAsDataURL(inputFile.files[0]);
        reader.readAsArrayBuffer(inputFile.files[0]);
    }
    function getResults(){
        // can we get the barcodes yet?
        Quagga.decodeSingle({
            decoder: {
                readers: ["code_39_reader"] // List of active readers
            },
            locate: true, // try to locate the barcode in the image
            src: Canvas1.toDataURL()
        }, function(result){
            var hh = Canvas1.previousElementSibling;
            if(result.codeResult) {
                hh.textContent = result.codeResult.code;
            } else {
                hh.textContent = "not detected";
            }
            Quagga.decodeSingle({
                decoder: {
                    readers: ["code_39_reader"], // List of active readers
                    multiple: false
                },
                locate: true, // try to locate the barcode in the image
                locator: {
                    halfSample: true,
                    patchSize: "large"
                },
                src: Canvas2.toDataURL()
            }, function(result){
                var hh = Canvas2.previousElementSibling;
                if(result.codeResult) {
                    hh.textContent = result.codeResult.code;
                } else {
                    hh.textContent = "not detected";
                }
                Quagga.decodeSingle({
                    decoder: {
                        readers: ["code_39_reader"] // List of active readers
                    },
                    locate: true, // try to locate the barcode in the image
                    src: Canvas3.toDataURL()
                }, function(result){
                    var hh = Canvas3.previousElementSibling;
                    if(result.codeResult) {
                        hh.textContent = result.codeResult.code;
                    } else {
                        hh.textContent = "not detected";
                    }
                });                
            });                
        });                

    }
</script>
</body>
</html>